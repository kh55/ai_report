# AI PR メトリクス ワークフロー プロジェクト - Cursor Rules

## 基本ガイドライン
- **日本語出力**: 全ての出力は日本語で行うこと
- **実行計画の表示**: コマンド実行や指示の際は、事前に実行計画を明示すること

## プロジェクト概要
このプロジェクトは、GitHub組織内のリポジトリにおけるAI関連Pull Request（PR）の比率を測定・分析するためのGitHub Actionsワークフローです。

## 技術スタック
- **GitHub Actions**: ワークフロー実行基盤
- **Shell Script (Bash)**: データ処理とロジック実装
- **GitHub REST API**: PR検索とメトリクス取得
- **jq**: JSON解析とデータ変換
- **curl**: API呼び出し
- **bc**: 算術計算

## ファイル構成
```
.
├── .github/workflows/
│   └── ai-pr-org-metrics.yml    # メインワークフローファイル
├── docs/
│   ├── README.md                # ドキュメント概要
│   ├── ai-pr-metrics-workflow-spec.md  # 詳細仕様書
│   └── troubleshooting-guide.md # トラブルシューティングガイド
└── .cursorrules                 # このファイル
```

## コーディング規約

### YAML (GitHub Actions)
- インデントは2スペース
- 文字列は必要に応じて引用符で囲む
- 複数行の文字列結合は避け、単一行で記述
- 環境変数は大文字で記述 (`GH_TOKEN`, `OWNER`)
- ステップ名は日本語で記述し、わかりやすくする

### Shell Script
- bashの厳密モード使用を推奨: `set -euo pipefail`
- 変数は`${}`で囲む: `${variable_name}`
- エラーハンドリングを必ず実装
- デバッグ用のechoを積極的に使用
- APIレスポンスの妥当性チェックを実装

### JSON処理 (jq)
- エラーハンドリングを含む: `.total_count // 0`
- パイプラインでの接続: `| jq -r '.items[]?.number'`
- 型安全な処理: `2>/dev/null || echo "0"`

## 開発方針

### 🎯 優先事項
1. **信頼性**: エラーハンドリングとフォールバック処理
2. **透明性**: 詳細なログ出力とデバッグ情報
3. **保守性**: わかりやすいコードと十分なドキュメント
4. **正確性**: 重複除去とデータ整合性の確保

### 🚨 重要な注意点
- **重複カウント防止**: 複数AIラベルを持つPRの適切な処理
- **日付フォーマット**: YYYY-MM-DD形式必須（タイムゾーン付き不可）
- **大文字小文字区別**: ラベル検索は厳密に区別される
- **APIレート制限**: 大量リポジトリでの制限考慮

### 🔧 エラー対応パターン
```bash
# API レスポンスの妥当性チェック
count=$(echo "$response" | jq -r '.total_count // 0' 2>/dev/null || echo "0")

# 算術演算のエラーハンドリング
pct=$(echo "scale=1; $ai_count*100/$all_count" | bc 2>/dev/null || echo "0")

# レート制限チェック
if echo "$response" | grep -q "rate limit"; then
  echo "::warning::API rate limit reached"
  sleep 60
fi
```

## AI支援の方向性

### 💡 コード生成時の指針
- **実用性重視**: 実際の運用で使える堅牢なコード
- **エラー対応**: 想定されるエラーケースの事前考慮
- **ログ充実**: トラブルシューティングに必要な情報出力
- **日本語コメント**: 日本語でのわかりやすい説明

### 📚 ドキュメント作成
- **実体験ベース**: 実際に発生した問題と解決策を記録
- **具体例豊富**: コードサンプルとコマンド例を多数収録
- **目的別構成**: 利用者・開発者・管理者別のガイド
- **継続更新**: 新しい問題や改善点の継続的な追加

### 🔄 リファクタリング方針
- **後方互換性**: 既存の動作を維持
- **段階的改善**: 小さな変更を積み重ね
- **テスト重視**: 変更前後での動作確認
- **ドキュメント更新**: コード変更に合わせたドキュメント更新

## セキュリティ要件

### 🔐 認証・認可
- **GitHub Token**: `METRICS_TOKEN` シークレット必須
- **権限スコープ**: `repo` スコープ付きPersonal Access Token
- **トークン保護**: プレーンテキストでの出力禁止

### 🛡️ データ保護
- **API制限**: 必要最小限のデータ取得
- **ログマスキング**: 機密情報の出力回避
- **権限確認**: リポジトリアクセス権限の事前確認

## パフォーマンス考慮

### ⚡ 効率化
- **並列処理**: 可能な箇所での並列実行検討
- **キャッシュ活用**: API結果のキャッシュ機能検討
- **バッチ処理**: 複数リポジトリの効率的な処理

### 📊 監視
- **実行時間**: ワークフロー実行時間の監視
- **API使用量**: レート制限の監視
- **エラー率**: 失敗率の追跡

## テスト戦略

### ✅ 検証項目
- YAML構文の妥当性
- API認証の確認
- 日付パラメータの検証
- 重複除去ロジックの確認
- エラーハンドリングの動作確認

### 🧪 テスト方法
- **ユニットテスト**: 個別機能の動作確認
- **統合テスト**: ワークフロー全体の動作確認
- **エラーテスト**: 異常系の動作確認
- **実データテスト**: 実際のリポジトリでの動作確認

## トラブルシューティング

### 🚨 一般的な問題
1. **YAML構文エラー**: 複数行文字列結合の問題
2. **API日付フォーマット**: タイムゾーン付き形式の非対応
3. **ORクエリ問題**: pasteコマンドでの文字変換
4. **重複カウント**: 複数AIラベル持ちPRの二重計算

### 🔧 診断手順
1. YAML構文の確認
2. API認証の確認
3. 日付パラメータの確認
4. ログの詳細確認
5. 手動でのAPI呼び出し確認

## 継続的改善

### 📈 改善方針
- **ユーザーフィードバック**: 利用者からの意見収集
- **パフォーマンス改善**: 実行時間とリソース使用量の最適化
- **機能拡張**: 新しい分析機能の追加
- **ドキュメント充実**: より詳細で実用的な説明

### 🔄 更新サイクル
- **定期レビュー**: 月次での動作確認
- **問題対応**: 発生した問題の即座の対応
- **機能追加**: 四半期ごとの機能追加検討
- **ドキュメント更新**: 変更に合わせた随時更新

---

## 開発時の心構え

1. **ユーザー第一**: 利用者の視点での機能設計
2. **信頼性重視**: エラーのない堅牢な実装
3. **透明性確保**: 動作が理解できる詳細なログ
4. **継続可能性**: 保守しやすいコードとドキュメント
5. **学習共有**: 得られた知見の積極的な共有

**このプロジェクトは、AI活用の可視化という重要な役割を担っています。品質と信頼性を最優先に開発を進めてください。** 